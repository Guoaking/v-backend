# KYCæœåŠ¡OpenTelemetryç›‘æ§é…ç½®å®ŒæˆæŠ¥å‘Š

## ğŸ‰ é…ç½®å®ŒæˆçŠ¶æ€

âœ… **æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼**

### 1. OpenTelemetryè‡ªåŠ¨æ’æ¡©é…ç½®
- âœ… åˆ›å»ºäº†OTelè‡ªåŠ¨æ’æ¡©ä¸­é—´ä»¶ (`internal/middleware/otel_instrumentation.go`)
- âœ… é›†æˆåˆ°Ginæ¡†æ¶ä¸­ï¼Œè‡ªåŠ¨è®°å½•HTTPè¯·æ±‚æŒ‡æ ‡
- âœ… æ”¯æŒé“¾è·¯è¿½è¸ªå’ŒæŒ‡æ ‡æ”¶é›†
- âœ… è‡ªåŠ¨è®°å½•è¯·æ±‚æ–¹æ³•ã€è·¯å¾„ã€çŠ¶æ€ç ã€å“åº”æ—¶é—´ç­‰

### 2. ä¸šåŠ¡æŒ‡æ ‡(metrics)é…ç½®
- âœ… åœ¨KYCæœåŠ¡ä¸­é›†æˆäº†OTelä¸šåŠ¡æŒ‡æ ‡
- âœ… é…ç½®äº†ä»¥ä¸‹ä¸šåŠ¡æŒ‡æ ‡ï¼š
  - `business_ocr_success_rate` - OCRæˆåŠŸç‡
  - `business_face_verify_success_rate` - äººè„¸è¯†åˆ«æˆåŠŸç‡  
  - `business_liveness_success_rate` - æ´»ä½“æ£€æµ‹æˆåŠŸç‡
  - `business_kyc_success_rate` - KYCæ•´ä½“æˆåŠŸç‡
  - `business_kyc_processing_time_seconds` - KYCå¤„ç†æ—¶é—´
- âœ… æŒ‡æ ‡è‡ªåŠ¨æš´éœ²ç»™Prometheusï¼ˆç«¯å£9090ï¼‰
- âœ… æ”¯æŒPrometheusæ ¼å¼æŒ‡æ ‡å¯¼å‡º

### 3. Prometheusé…ç½®
- âœ… é…ç½®äº†PrometheusæŠ“å–KYCæœåŠ¡æŒ‡æ ‡
- âœ… æ”¯æŒåŒæ•°æ®æºï¼š
  - ç«¯å£8082ï¼šåŸæœ‰åº”ç”¨æŒ‡æ ‡
  - ç«¯å£9090ï¼šOpenTelemetryæŒ‡æ ‡
- âœ… é…ç½®äº†Prometheusé…ç½®æ–‡ä»¶ (`scripts/prometheus-config.yml`)

### 4. Grafanaä»ªè¡¨æ¿é…ç½®
- âœ… åˆ›å»ºäº†ä¸“é—¨çš„OpenTelemetryç›‘æ§ä»ªè¡¨æ¿ (`grafana/kyc-otel-dashboard.json`)
- âœ… è‡ªåŠ¨å¯¼å…¥è„šæœ¬ (`scripts/import-grafana-otel.sh`)
- âœ… é…ç½®äº†ä»¥ä¸‹ç›‘æ§é¢æ¿ï¼š
  - HTTPè¯·æ±‚é€Ÿç‡
  - HTTPè¯·æ±‚å»¶è¿ŸP95
  - KYCä¸šåŠ¡æˆåŠŸç‡
  - KYCå¤„ç†æ—¶é—´åˆ†å¸ƒ
  - KYCè¯·æ±‚é€Ÿç‡
  - ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨é€Ÿç‡
  - CPUä½¿ç”¨ç‡
  - å†…å­˜ä½¿ç”¨ç‡
  - Goroutineæ•°é‡

### 5. æœåŠ¡è®¿é—®ä¿¡æ¯

#### KYCæœåŠ¡
- ğŸŒ **æœåŠ¡åœ°å€**: http://localhost:8082
- ğŸ¥ **å¥åº·æ£€æŸ¥**: http://localhost:8082/health
- ğŸ“Š **åº”ç”¨æŒ‡æ ‡**: http://localhost:8082/metrics
- ğŸ” **OTelæŒ‡æ ‡**: http://localhost:9090/metrics

#### ç›‘æ§é¢æ¿
- ğŸ“ˆ **Grafana**: http://localhost:3001
  - ç”¨æˆ·å: admin
  - å¯†ç : admin123
- ğŸ” **Jaeger UI**: http://localhost:16686
- ğŸ“Š **Prometheus UI**: http://localhost:9091

#### æ•°æ®åº“å’Œç¼“å­˜
- ğŸ—„ï¸ **PostgreSQL**: localhost:5433
- ğŸ”„ **Redis**: localhost:6380

### 6. æµ‹è¯•éªŒè¯

#### æµ‹è¯•å‘½ä»¤
```bash
# è·å–è®¿é—®ä»¤ç‰Œ
TOKEN=$(curl -s -X POST http://localhost:8082/api/v1/auth/token \
  -H "Content-Type: application/json" \
  -d '{
    "client_id": "test-client",
    "client_secret": "test-secret", 
    "grant_type": "client_credentials",
    "scope": "kyc:read kyc:write"
  }' | jq -r .access_token)

# æµ‹è¯•OCRæ¥å£
curl -X POST http://localhost:8082/api/v1/kyc/ocr \
  -H "Authorization: Bearer $TOKEN" \
  -F "image=@test.jpg" \
  -F "language=auto"

# æŸ¥çœ‹æŒ‡æ ‡
curl -s http://localhost:8082/metrics | grep kyc
curl -s http://localhost:9090/metrics | grep otel
```

### 7. å…³é”®ç‰¹æ€§

#### è‡ªåŠ¨æ’æ¡©
- è‡ªåŠ¨è®°å½•æ‰€æœ‰HTTPè¯·æ±‚çš„traceä¿¡æ¯
- è‡ªåŠ¨æ”¶é›†è¯·æ±‚æŒ‡æ ‡ï¼ˆQPSã€å»¶è¿Ÿã€é”™è¯¯ç‡ï¼‰
- æ”¯æŒåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

#### ä¸šåŠ¡æŒ‡æ ‡
- å®æ—¶KYCä¸šåŠ¡æˆåŠŸç‡ç›‘æ§
- OCRã€äººè„¸è¯†åˆ«ã€æ´»ä½“æ£€æµ‹å„ç¯èŠ‚æŒ‡æ ‡
- å¤„ç†æ—¶é—´åˆ†å¸ƒç»Ÿè®¡

#### å¯è§†åŒ–ç›‘æ§
- ä¸“ä¸šçš„Grafanaä»ªè¡¨æ¿
- å®æ—¶ä¸šåŠ¡æŒ‡æ ‡å±•ç¤º
- é“¾è·¯è¿½è¸ªå¯è§†åŒ–

### 8. ç®¡ç†å‘½ä»¤

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f [service-name]

# åœæ­¢æœåŠ¡
docker-compose down

# é‡å¯æœåŠ¡
docker-compose restart [service-name]

# é‡æ–°å¯¼å…¥Grafanaä»ªè¡¨æ¿
./scripts/import-grafana-otel.sh
```

### 9. æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   KYC Service   â”‚â”€â”€â”€â–¶â”‚  OTel Metrics   â”‚â”€â”€â”€â–¶â”‚   Prometheus    â”‚
â”‚   Port: 8082    â”‚    â”‚   Port: 9090    â”‚    â”‚   Port: 9091    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OTel Tracing   â”‚    â”‚   Jaeger UI     â”‚    â”‚   Grafana UI    â”‚
â”‚   Jaeger        â”‚    â”‚  Port: 16686    â”‚    â”‚  Port: 3001    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10. ä¸‹ä¸€æ­¥å»ºè®®

1. **å‘Šè­¦é…ç½®**: å¯ä»¥é…ç½®Prometheuså‘Šè­¦è§„åˆ™
2. **æ—¥å¿—é›†æˆ**: é›†æˆç»“æ„åŒ–æ—¥å¿—åˆ°ç›‘æ§ä½“ç³»
3. **æ€§èƒ½ä¼˜åŒ–**: æ ¹æ®ç›‘æ§æ•°æ®ä¼˜åŒ–æœåŠ¡æ€§èƒ½
4. **æ‰©å±•æŒ‡æ ‡**: æ·»åŠ æ›´å¤šä¸šåŠ¡ç›¸å…³æŒ‡æ ‡
5. **å®‰å…¨åŠ å›º**: é…ç½®ç›‘æ§ç³»ç»Ÿçš„å®‰å…¨è®¿é—®

## ğŸ¯ æ€»ç»“

OpenTelemetryç›‘æ§é…ç½®å·²å…¨é¢å®Œæˆï¼Œæä¾›äº†ï¼š
- ğŸ” å®Œæ•´çš„é“¾è·¯è¿½è¸ªèƒ½åŠ›
- ğŸ“Š ä¸°å¯Œçš„ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
- ğŸ“ˆ å¯è§†åŒ–çš„ç›‘æ§ä»ªè¡¨æ¿
- ğŸš¨ å¯æ‰©å±•çš„ç›‘æ§æ¶æ„

æ•´ä¸ªç›‘æ§é“¾è·¯å·²ç»æ‰“é€šï¼Œå¯ä»¥å®æ—¶ç›‘æ§KYCæœåŠ¡çš„è¿è¡ŒçŠ¶æ€å’Œä¸šåŠ¡æµç¨‹ã€‚