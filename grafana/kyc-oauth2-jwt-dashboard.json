{
  "dashboard": {
    "id": null,
    "uid": "kyc-business-oauth2-jwt",
    "title": "KYC业务认证监控 - OAuth2 & JWT",
    "tags": ["kyc", "business", "oauth2", "jwt", "authentication"],
    "timezone": "browser",
    "refresh": "30s",
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "panels": [
      {
        "id": 1,
        "title": "OAuth2认证成功率",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(kong_plugin_oauth2_authorization_total{service=\"oauth2-auth-service\",code=~\"2..\"}[5m]) / rate(kong_plugin_oauth2_authorization_total{service=\"oauth2-auth-service\"}[5m]) * 100",
            "legendFormat": "成功率 (%)"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "decimals": 2,
            "thresholds": {
              "steps": [
                {"color": "red", "value": 0},
                {"color": "yellow", "value": 90},
                {"color": "green", "value": 98}
              ]
            }
          }
        },
        "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0}
      },
      {
        "id": 2,
        "title": "JWT验证成功率",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(kong_plugin_jwt_success_total[5m]) / (rate(kong_plugin_jwt_success_total[5m]) + rate(kong_plugin_jwt_failure_total[5m])) * 100",
            "legendFormat": "成功率 (%)"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "decimals": 2,
            "thresholds": {
              "steps": [
                {"color": "red", "value": 0},
                {"color": "yellow", "value": 95},
                {"color": "green", "value": 99}
              ]
            }
          }
        },
        "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0}
      },
      {
        "id": 3,
        "title": "OAuth2令牌颁发速率",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(kong_plugin_oauth2_token_total[1m])",
            "legendFormat": "令牌/秒"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "reqps",
            "thresholds": {
              "steps": [
                {"color": "green", "value": 0},
                {"color": "yellow", "value": 10},
                {"color": "red", "value": 50}
              ]
            }
          }
        },
        "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0}
      },
      {
        "id": 4,
        "title": "认证失败次数",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(kong_plugin_oauth2_authorization_total{service=\"oauth2-auth-service\",code=~\"4..|5..\"}[5m]) + rate(kong_plugin_jwt_failure_total[5m])",
            "legendFormat": "失败/秒"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "reqps",
            "thresholds": {
              "steps": [
                {"color": "green", "value": 0},
                {"color": "yellow", "value": 1},
                {"color": "red", "value": 5}
              ]
            }
          }
        },
        "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0}
      },
      {
        "id": 5,
        "title": "OAuth2认证趋势",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(kong_plugin_oauth2_authorization_total{service=\"oauth2-auth-service\",code=~\"2..\"}[1m])",
            "legendFormat": "成功认证"
          },
          {
            "expr": "rate(kong_plugin_oauth2_authorization_total{service=\"oauth2-auth-service\",code=~\"4..\"}[1m])",
            "legendFormat": "客户端错误"
          },
          {
            "expr": "rate(kong_plugin_oauth2_authorization_total{service=\"oauth2-auth-service\",code=~\"5..\"}[1m])",
            "legendFormat": "服务器错误"
          }
        ],
        "yAxes": [
          {"label": "请求/秒", "min": 0},
          {"label": "", "min": 0}
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4}
      },
      {
        "id": 6,
        "title": "JWT验证趋势",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(kong_plugin_jwt_success_total[1m])",
            "legendFormat": "验证成功"
          },
          {
            "expr": "rate(kong_plugin_jwt_failure_total[1m])",
            "legendFormat": "验证失败"
          }
        ],
        "yAxes": [
          {"label": "请求/秒", "min": 0},
          {"label": "", "min": 0}
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4}
      },
      {
        "id": 7,
        "title": "客户端认证分布",
        "type": "piechart",
        "targets": [
          {
            "expr": "sum by (consumer) (rate(kong_http_requests_total{service=\"kyc-service\"}[5m]))",
            "legendFormat": "{{consumer}}"
          }
        ],
        "options": {
          "pieType": "pie",
          "tooltip": {
            "mode": "single"
          },
          "legend": {
            "displayMode": "table",
            "placement": "right"
          }
        },
        "gridPos": {"h": 8, "w": 8, "x": 0, "y": 12}
      },
      {
        "id": 8,
        "title": "令牌类型分布",
        "type": "piechart",
        "targets": [
          {
            "expr": "sum by (credential_type) (rate(kong_plugin_oauth2_token_total[5m]))",
            "legendFormat": "{{credential_type}}"
          }
        ],
        "options": {
          "pieType": "donut",
          "tooltip": {
            "mode": "single"
          }
        },
        "gridPos": {"h": 8, "w": 8, "x": 8, "y": 12}
      },
      {
        "id": 9,
        "title": "权限组访问分布",
        "type": "piechart",
        "targets": [
          {
            "expr": "sum by (group) (rate(kong_plugin_acl_allowed_total[5m]))",
            "legendFormat": "{{group}}"
          }
        ],
        "options": {
          "pieType": "pie",
          "tooltip": {
            "mode": "single"
          }
        },
        "gridPos": {"h": 8, "w": 8, "x": 16, "y": 12}
      },
      {
        "id": 10,
        "title": "OAuth2错误类型分析",
        "type": "table",
        "targets": [
          {
            "expr": "sum by (error, error_description) (rate(kong_plugin_oauth2_errors_total[10m]))",
            "legendFormat": ""
          }
        ],
        "transformations": [
          {
            "id": "organize",
            "options": {
              "excludeByName": {
                "Time": true
              },
              "indexByName": {},
              "renameByName": {
                "error": "错误类型",
                "error_description": "错误描述",
                "Value": "错误频率"
              }
            }
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 20}
      },
      {
        "id": 11,
        "title": "JWT错误类型分析",
        "type": "table",
        "targets": [
          {
            "expr": "sum by (error) (rate(kong_plugin_jwt_failure_total[10m]))",
            "legendFormat": ""
          }
        ],
        "transformations": [
          {
            "id": "organize",
            "options": {
              "excludeByName": {
                "Time": true
              },
              "renameByName": {
                "error": "错误类型",
                "Value": "错误频率"
              }
            }
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 20}
      },
      {
        "id": 12,
        "title": "令牌过期监控",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(kong_plugin_oauth2_token_expired_total[1m])",
            "legendFormat": "令牌过期"
          },
          {
            "expr": "rate(kong_plugin_jwt_token_expired_total[1m])",
            "legendFormat": "JWT过期"
          }
        ],
        "yAxes": [
          {"label": "过期/秒", "min": 0},
          {"label": "", "min": 0}
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 28}
      },
      {
        "id": 13,
        "title": "认证延迟分布",
        "type": "heatmap",
        "targets": [
          {
            "expr": "rate(kong_plugin_oauth2_latency_ms_bucket[1m])",
            "legendFormat": "{{le}}"
          }
        ],
        "yAxis": {
          "max": 1000,
          "min": 0
        },
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 28}
      },
      {
        "id": 14,
        "title": "消费者活跃度排行",
        "type": "table",
        "targets": [
          {
            "expr": "topk(10, sum by (consumer) (rate(kong_http_requests_total{service=\"kyc-service\"}[5m])))",
            "legendFormat": ""
          }
        ],
        "transformations": [
          {
            "id": "organize",
            "options": {
              "excludeByName": {
                "Time": true
              },
              "renameByName": {
                "consumer": "消费者",
                "Value": "请求频率 (req/s)"
              }
            }
          }
        ],
        "gridPos": {"h": 8, "w": 8, "x": 0, "y": 36}
      },
      {
        "id": 15,
        "title": "作用域使用统计",
        "type": "table",
        "targets": [
          {
            "expr": "sum by (scope) (rate(kong_plugin_oauth2_token_total[5m]))",
            "legendFormat": ""
          }
        ],
        "transformations": [
          {
            "id": "organize",
            "options": {
              "excludeByName": {
                "Time": true
              },
              "renameByName": {
                "scope": "作用域",
                "Value": "使用频率"
              }
            }
          }
        ],
        "gridPos": {"h": 8, "w": 8, "x": 8, "y": 36}
      },
      {
        "id": 16,
        "title": "刷新令牌使用",
        "type": "table",
        "targets": [
          {
            "expr": "sum by (consumer) (rate(kong_plugin_oauth2_refresh_token_total[5m]))",
            "legendFormat": ""
          }
        ],
        "transformations": [
          {
            "id": "organize",
            "options": {
              "excludeByName": {
                "Time": true
              },
              "renameByName": {
                "consumer": "消费者",
                "Value": "刷新频率"
              }
            }
          }
        ],
        "gridPos": {"h": 8, "w": 8, "x": 16, "y": 36}
      },
      {
        "id": 17,
        "title": "认证告警",
        "type": "alertlist",
        "targets": [],
        "options": {
          "showOptions": "current",
          "maxItems": 10,
          "sortOrder": "importance",
          "dashboardAlerts": true,
          "alertName": "认证失败告警"
        },
        "gridPos": {"h": 8, "w": 24, "x": 0, "y": 44}
      }
    ],
    "templating": {
      "list": [
        {
          "name": "consumer",
          "type": "query",
          "query": "label_values(kong_http_requests_total{service=\"kyc-service\"}, consumer)",
          "refresh": 1,
          "multi": true,
          "includeAll": true
        },
        {
          "name": "time_range",
          "type": "interval",
          "options": ["1m", "5m", "10m", "30m", "1h", "6h", "12h", "1d"],
          "current": {"text": "5m", "value": "5m"}
        }
      ]
    },
    "annotations": {
      "list": [
        {
          "name": "认证事件",
          "datasource": "Prometheus",
          "expr": "kong_plugin_oauth2_authorization_total{service=\"oauth2-auth-service\"} > 0",
          "titleFormat": "OAuth2认证事件",
          "textFormat": "消费者: {{consumer}}, 状态: {{code}}",
          "iconColor": "rgba(255, 96, 96, 1)"
        }
      ]
    },
    "alert": {
      "conditions": [
        {
          "query": {
            "params": ["A", "5m", "now"]
          },
          "reducer": {
            "type": "avg",
            "params": []
          },
          "evaluator": {
            "params": [90],
            "type": "lt"
          },
          "operator": {
            "type": "and"
          }
        }
      ],
      "executionErrorState": "alerting",
      "frequency": "1m",
      "handler": 1,
      "name": "OAuth2认证成功率低于90%",
      "message": "OAuth2认证成功率低于90%，请检查认证服务状态",
      "noDataState": "no_data",
      "notifications": []
    }
  }
}